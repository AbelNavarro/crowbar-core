#!/bin/bash
#
# This script executes crowbar_join and initial chef-client run on upgraded node

LOGFILE=/var/log/crowbar/node-upgrade.log
UPGRADEDIR=/var/lib/crowbar/upgrade
mkdir -p "`dirname "$LOGFILE"`"
exec >>"$LOGFILE" 2>&1

echo "Executing $BASH_SOURCE"

set -x

mkdir -p $UPGRADEDIR
rm -f $UPGRADEDIR/crowbar-chef-upgraded-failed

if [[ -f $UPGRADEDIR/crowbar-chef-upgraded-ok ]] ; then
    echo "crowbar_join and chef-client actions were already successfully executed"
    exit 0
fi

# Move node to ready state and execute chef-client for the first time
crowbar_join --start

<% if @compute_node %>
<% # FIXME: manually starting nova-compute service as it might not be running (bsc#1016302) %>
systemctl start openstack-nova-compute.service

ret=$?
if [ $ret != 0 ] ; then
    echo "Error occured while starting openstack-nova-compute service"
    echo $ret > $UPGRADEDIR/crowbar-chef-upgraded-failed
    return $ret
fi
<% end %>


touch $UPGRADEDIR/crowbar-chef-upgraded-ok

#!/bin/bash
#
# This script starts the upgrade of the node server to the latest version of
# system and Cloud product.

LOGFILE=/var/log/crowbar/node-upgrade.log
mkdir -p "`dirname "$LOGFILE"`"
exec >>"$LOGFILE" 2>&1

echo "Executing $BASH_SOURCE"

set -x

<% if @use_ha %>

<% if @cluster_founder %>
echo "Stopping pacemaker resources..."

exclude="postgresql|vip|rabbitmq|keystone|neutron|haproxy"

for type in clone ms primitive; do
    for resource in $(crm configure show | grep ^$type | grep -Ev $exclude | cut -d " " -f2);
    do
        crm --force --wait resource stop $resource
    done
done

<% end %>

# stop cinder-volume at all nodes so the service could be removed from the database later
/etc/init.d/openstack-cinder-volume stop

<% else %>

# Stop openstack services on this node.
# Note that for HA setup, they should be stopped by pacemaker.
echo "Stopping OpenStack services..."

for i in /etc/init.d/openstack-* \
         /etc/init.d/apache2 \
         /etc/init.d/rabbitmq-server \
         /etc/init.d/ovs-usurp-config-* \
         /etc/init.d/hawk;
do
    if test -e $i; then
        $i stop
    fi
done

<% end %>

<% if @cinder_controller && (!@use_ha || @cluster_founder) %>

# all cinder services must be stopped
while cinder-manage service list 2>/dev/null | grep -q ":-)"; do
  echo "Some cinder services are still running"
  sleep 5
done

for service in cinder-volume cinder-scheduler; do
    hosts=$(cinder-manage service list | grep $service | tr -s ' ' | cut -d ' ' -f 2)
    for host in $hosts; do
        cinder-manage service remove $service $host 2>/dev/null
    done
done

<% end %>

.column_100
  - unless @nodes.empty?
    %section.box#details
      - if @node
        = render :partial => 'show'
      - else
        %p= t("status_empty", :scope=>"nodes.index") % @nodes.count

#nodes
  - if @nodes.nil?
    = t('no_items')
  - else
    - @nodes.group_by(&:group).each_with_index do |group, i|
      .column_25{:class => column_class(i,4)}
        %table.data.box{:id => "group_#{(group[0] || t('unknown')).parameterize}"}
          %thead
            %tr
              %th.status{:title => t('updating')}
                - status = group[1].collect{|c| c.status}.inject(Hash.new(0)){|h,v| h[v] += 1; h}
                .inline_piechart= [status["ready"], status["failed"], status["unknown"], status["unready"]+status["pending"]] * ","
              %th= (group[0] || t('unknown'))
  
          %tbody
            - group[1].sort_by{|n| n.group_order }.each do |node|
              %tr{ :class => ["node", cycle(:odd, :even, :name => "nodes_#{i}")], :id => node.shortname }
                %td.status{:raw=> node.state}
                  .led{:class => node.status, :title=>t("state.#{node.state}")}
                %td.name
                  %a{:href => node_path(node.shortname), :title=> "#{NodeObject.human_attribute_name :description}: #{(node.nil? ? t(:not_set) : node.description)}", :class => 'node_details', :id => node.shortname.parameterize}= node.shortname
  
.clear

:javascript
  groups = {};
  selected = '#{session[:node]}';
  
  function pie_title(total, ready, failed, unknown, unready, pending, building) {
    var status = "#{t :status_pie, :scope=>'nodes.index'}";
    status = status.replace("{0}", total);
    status = status.replace("{1}", ready);
    status = status.replace("{2}", failed);
    status = status.replace("{3}", unknown);
    status = status.replace("{4}", unready+pending+building);
    return status;
  }
  
  function update() {
    $.ajaxSetup({ timeout: 3000 })
    $.getJSON('#{nodes_status_path}', function(data) {
      
      // reload path
      var repath = '#{dashboard_path}/'+selected;
      
      // If node count has changed, re-render the page
      var current_nodes = $('.node').length;
      if(data['count'] != current_nodes) {
        location.href = repath;
      }

      // If node name sum has changed, re-render the page
      if(data['sum'] != #{@sum}) {
        location.href = repath;
      }
      
      // Update group-level piecharts
      $.each(data['groups'], function(key,val) {
        var values = val['ready'] + ', ' + val['failed'] + ', ' + val['unknown'] + ', ' + (val['building']+val['unready']+val['pending']);
        var total = val['ready']+val['unready']+val['unknown']+val['building']+val['pending']+val['failed'];
        if (groups[key]==undefined) { 
          groups[key] = total; 
        } else if (groups[key]!=total) {
          location.href =repath;
        }
        $('#group_'+key.toLowerCase()+' th.status .inline_piechart').html(values).sparkline('html', piechart_options );
        $('#group_'+key.toLowerCase()+' th.status').attr('title', pie_title(total, val['ready'], val['failed'], val['unknown'], val['building'], val['unready'], val['pending']));
      });
      
      // Update nodes
      $.each(data['nodes'], function(key,val) {
        var td = $('#'+key+' td.status');
        var led = td.children('.led');
        if(!(td.attr('raw') === val['raw'])) {
          led.destroy();
          led.attr('class', 'led '+val['status']);
          td.attr('raw', val['raw']);
          td.effect("highlight", {color: '#666666'}, 2000);
          led.attr('title', val['state']);
        }
        // catch the case where we've expanded detail on a node
        s = $('div.container dd.node_state');
        h_key = "head_"+key;
        h = $('div.container div.led[id="'+h_key+'"]');
        if (h.attr('id')==h_key && s.text()!=val['state']) {
          s.text(val['state']);
          s.effect("highlight", {color: '#666666'}, 2000);
          s.attr('title','#{t('raw')}: '+val['raw']);
          var head = $('#head_'+key);
          if (head.length !=0 ) {
            head.destroy();
            head.attr('class', 'led '+val['status']);
            head.attr('title', val['state']);
          }
        }
      });
      
    });
  }

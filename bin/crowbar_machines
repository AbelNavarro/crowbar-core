#!/usr/bin/env ruby
#
# Copyright 2011-2013, Dell
# Copyright 2013-2015, SUSE Linux GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

require "getoptlong"
require "active_support/all"

@hostname = ENV["CROWBAR_IP"] || "127.0.0.1"
@port = ENV["CROWBAR_PORT"] || 80

@debug = false
@allow_zero_args = false
@timeout = 500
@crowbar_key_file = "/etc/crowbar.install.key"

@options = [
  [["--help", "-h", GetoptLong::NO_ARGUMENT], "--help or -h - help"],
  [["--username", "-U", GetoptLong::REQUIRED_ARGUMENT], "--username <username> or -U <username>  - specifies the username"],
  [["--password", "-P", GetoptLong::REQUIRED_ARGUMENT], "--password <password> or -P <password>  - specifies the password"],
  [["--hostname", "-n", GetoptLong::REQUIRED_ARGUMENT], "--hostname <name or ip> or -n <name or ip>  - specifies the destination server"],
  [["--port", "-p", GetoptLong::REQUIRED_ARGUMENT], "--port <port> or -p <port> - specifies the destination server port"],
  [["--debug", "-d", GetoptLong::NO_ARGUMENT], "--debug or -d - turns on debugging information"],
  [["--timeout", GetoptLong::REQUIRED_ARGUMENT], "--timeout <seconds> - timeout in seconds for read http reads"]
]

@commands = {
  "help" => [
    "usage 0",
    "help - this page"
  ],
  "list" => [
    "list",
    "list - Show a list of current node handles"
  ],
  "aliases" => [
    "aliases",
    "aliases - Show a list of current node aliases"
  ],
  "show" => [
    "show ARGV.shift, ARGV.shift",
    "show <name or alias> [arg] - Show a specific config"
  ],
  "delete" => [
    "delete ARGV.shift",
    "delete <name or alias> - Delete a node"
  ],
  "reboot" => [
    "action \"reboot\", ARGV.shift",
    "reboot <name or alias> - Reboot a node"
  ],
  "shutdown" => [
    "action \"shutdown\", ARGV.shift",
    "shutdown <name or alias> - Shutdown a node"
  ],
  "poweron" => [
    "action \"poweron\", ARGV.shift",
    "poweron <name or alias> - Poweron a node"
  ],
  "powercycle" => [
    "action \"powercycle\", ARGV.shift",
    "powercycle <name or alias> - Power cycle a node"
  ],
  "poweroff" => [
    "action \"poweroff\", ARGV.shift",
    "poweroff <name or alias> - Power off a node"
  ],
  "identify" => [
    "action \"identify\", ARGV.shift",
    "identify <name or alias> - Identify a node"
  ],
  "allocate" => [
    "action \"allocate\", ARGV.shift",
    "allocate <name or alias> - Allocate a node"
  ],
  "reset" => [
    "action \"reset\", ARGV.shift",
    "reset <name or alias> - Reset a node"
  ],
  "reinstall" => [
    "action \"reinstall\", ARGV.shift",
    "reinstall <name or alias> - Reinstall a node"
  ],
  "update" => [
    "action \"update\", ARGV.shift",
    "update <name or alias> - Hardware update a node"
  ],
  "rename" => [
    "rename ARGV.shift, ARGV.shift",
    "rename <name or alias> <new_alias> - Rename a node alias"
  ],
  "role" => [
    "role ARGV.shift, ARGV.shift",
    "role <name or alias> <intended role> - Assign an intended role"
  ],
  "api_help" => [
    "api_help",
    "api_help - Crowbar API help for this barclamp"
  ]
}

def print_commands(cmds, spacer = "  ")
  cmds.each do |key, command|
    puts "#{spacer}#{command[1]}"
    print_commands(command[2], "  #{spacer}") if command[0] =~ /run_sub_command\(/
  end
end

def usage(rc)
  puts "Usage: crowbar machines [options] <subcommands>"
  @options.each do |options|
    puts "  #{options[1]}"
  end
  print_commands(@commands.sort)
  exit rc
end

def opt_parse
  get_user_password
  standard_opt_parse

  if ARGV.length == 0 and !@allow_zero_args
    usage -1
  end

  check_user_password
end

def get_user_password
  key = ENV["CROWBAR_KEY"]

  if key.nil? and ::File.exists?(@crowbar_key_file) and ::File.readable?(@crowbar_key_file)
    begin
      key = File.read(@crowbar_key_file).strip
    rescue => e
      warn "Unable to read crowbar key from #{@crowbar_key_file}: #{e}"
    end
  end

  if key
    @username, @password = key.split(":",2)
  end
end

def standard_opt_parse
  sub_options = @options.map { |x| x[0] }
  opts = GetoptLong.new(*sub_options)

  opts.each do |opt, arg|
    if ! parse_standard_opt(opt, arg)
      parse_extra_opt(opt, arg)
    end
  end
end

def parse_standard_opt(opt, arg)
  case opt
  when "--help"
    usage 0
  when "--debug"
    @debug = true
  when "--hostname"
    @hostname = arg
  when "--username"
    @username = arg
  when "--password"
    @password = arg
  when "--port"
    @port = arg.to_i
  when "--timeout"
    @timeout = arg.to_i
  else
    return false
  end

  return true
end

def parse_extra_opt(opt, arg)
  found = false
  @options.each do |x|
    next unless x[0].include? opt
    x[2].call(opt, arg)
    found = true
  end
  usage(-1) unless found
end

def check_user_password
  if @username.nil? or @password.nil?
    STDERR.puts "CROWBAR_KEY not set, will not be able to authenticate!"
    STDERR.puts "Please set CROWBAR_KEY or use -U and -P"
    exit 1
  end
end

def deprecated_message(msg)
  if $stdout.tty?
    $stderr.puts "\e[31m#{msg}\e[0m"
  else
    $stderr.puts msg
  end
end

def deprecated_exec(*cmd)
  execute = [
    "crowbarctl"
  ].concat(
    cmd
  )

  if @username.present?
    execute.push "-U '#{@username}'"
  end

  if @password.present?
    execute.push "-P '#{@password}'"
  end

  if @timeout != 500
    execute.push "-t #{@timeout}"
  end

  if @hostname != "127.0.0.1" || @port != 80
    execute.push "-s 'http://#{@hostname}:#{@port}'"
  end

  if @username.empty? && @password.empty?
    execute.push "--anonymous"
  end

  if @debug
    execute.push "--debug"
  end

  deprecated_message <<-MSG.strip_heredoc
    This command is deprecated, please use:
    #{execute.join(" ")}
  MSG

  exec(execute.join(" "))
end

def run_sub_command(cmds, subcmd)
  if [
    "list",
    "aliases",
    "show",
    "delete",
    "reboot",
    "shutdown",
    "poweron",
    "powercycle",
    "poweroff",
    "identify",
    "allocate",
    "reset",
    "reinstall",
    "update",
    "rename",
    "role",
    "api_help"
  ].include?(subcmd)
    case subcmd
    when "api_help"
      res = deprecated_exec(
        "server",
        "api",
        "machines"
      )
    when "list"
      res = deprecated_exec(
        "node",
        "list",
        "--no-aliases",
        "--format plain"
      )
    when "aliases"
      res = deprecated_exec(
        "node",
        "list",
        "--format plain"
      )
    when "delete"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "delete",
        name
      )
    when "reboot"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "reboot",
        name
      )
    when "shutdown"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "shutdown",
        name
      )
    when "poweron"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "poweron",
        name
      )
    when "powercycle"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "powercycle",
        name
      )
    when "poweroff"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "poweroff",
        name
      )
    when "identify"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "identify",
        name
      )
    when "allocate"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "allocate",
        name
      )
    when "reset"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "reset",
        name
      )
    when "reinstall"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "reinstall",
        name
      )
    when "update"
      usage(-2) unless ARGV.length == 1

      name = ARGV.shift

      res = deprecated_exec(
        "node",
        "hardware",
        name
      )
    when "rename"
      usage(-2) unless ARGV.length == 2

      name = ARGV.shift
      value = ARGV.shift

      res = deprecated_exec(
        "node",
        "rename",
        name,
        value
      )
    when "role"
      usage(-2) unless ARGV.length == 2

      name = ARGV.shift
      value = ARGV.shift

      res = deprecated_exec(
        "node",
        "role",
        name,
        value
      )
    when "show"
      usage(-2) if ARGV.length < 1 || ARGV.length > 2

      name = ARGV.shift
      filter = ARGV.shift

      res = deprecated_exec(
        "node",
        "show",
        name,
        filter ? "--filter #{filter}" : nil,
        "--format json"
      )
    end

    return [
      "",
      res || 1
    ]
  end

  cmd = cmds[subcmd]
  usage(-2) if cmd.nil?
  eval cmd[0]
end

def run_command
  run_sub_command(@commands, ARGV.shift)
end

def main
  opt_parse
  res = run_command
  puts res[0]
  exit res[1]
end

main
